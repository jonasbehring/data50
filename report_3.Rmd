```{r include=FALSE}
library(dplyr)
library(tidyr)
library(DBI)
library(purrr)

politicians_db <- dbConnect(RSQLite::SQLite(), "zh_politicians.db")

addresses_tbl <- tbl(politicians_db, "Addresses")
affilations_tbl <- tbl(politicians_db, "Affiliations")
mandates_tbl <- tbl(politicians_db, "Mandates")
persons_tbl <- tbl(politicians_db, "Persons")

library(lubridate)
library(janitor)

mandates <-
mandates_tbl %>%
  collect

persons <- 
persons_tbl %>%
  collect 

affilations <-
affilations_tbl %>%
  collect

```

# Report 3
## Exercises
### Part 1
#### How many survey participants were there?
```{r}

mandates <-
mandates %>%
  filter(MANDATE_START_DAY > 0) %>%
  mutate(StartDate = make_date(MANDATE_START_YEAR, MANDATE_START_MONTH, MANDATE_START_DAY),
         MANDATE_END_YEAR = case_when(
         MANDATE_END_YEAR==0 ~ as.integer(format(Sys.Date(),'%Y')),
         TRUE ~ MANDATE_END_YEAR),
         MANDATE_END_MONTH = case_when(
         MANDATE_END_MONTH==0 ~ as.integer(format(Sys.Date(),'%m')),
         TRUE ~ MANDATE_END_MONTH),
         MANDATE_END_DAY = case_when(
         MANDATE_END_DAY==0 ~ as.integer(format(Sys.Date(),'%d')),
         TRUE ~ MANDATE_END_DAY),
         active_years = map2(MANDATE_START_YEAR, MANDATE_END_YEAR, seq)) 
  
unnested_data <-
unnest(mandates, active_years) %>%
  group_by(active_years, ASSEMBLY) %>%
  summarise(sum = n())


library(ggplot2)
ggplot(data=unnested_data, 
       mapping=aes(x=active_years, y=sum, color=ASSEMBLY)) + 
  geom_line() + 
  labs(title="Number of active mandats per year",
       subtitle="The peaks are caused by election years when multiple mandates were active for the same seat",
       x="years", y="n") 
```


### Part 2
#### Expand on the plot you just produced. This time you want to show a facet charts with one chart per assembly. In each chart, have one line for men and one line for women.

```{r}

mandates_with_names <- left_join(mandates, persons, by = c("PERSON_ID" = "ID"))

unnested_data <-
unnest(mandates_with_names, active_years) %>%
  group_by(active_years, ASSEMBLY, GENDER) %>%
  filter(GENDER != "") %>%
  summarise(sum = n())

ggplot(data = unnested_data, 
       mapping=aes(x=active_years, y=sum, color=GENDER)) + 
  geom_line() + 
  labs(title="Number of active mandats per year by assembly",
       x="years", y="n") +
  facet_wrap(~ASSEMBLY)

```


### Part 3
#### Create a new plot showing the proportion of elected politicians from each party in year 2000. You want to show this by assembly, so use one facet with one pie chart per assembly.

```{r}

politicians_in_2000 <-
unnest(mandates, active_years) %>%
  filter(active_years == 2000)%>%
  left_join(affilations, by = c("ID" = "MANDATE_ID")) %>%
  select(PARTY, ASSEMBLY) %>%
  group_by(PARTY, ASSEMBLY) %>%
  summarise(sum = n())

 

```

{r include=FALSE}
dbDisconnect(politicians_db)
```
